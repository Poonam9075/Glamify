<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
    <title>Professional Dashboard</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          rel="stylesheet">
</head>

<body onload="requireAuth(); loadAppointments();">

<!-- Navbar -->
<div id="navbar"></div>

<div class="container mt-4">

    <h3 class="mb-4">Assigned Appointments</h3>

    <div class="card shadow">
        <div class="card-body">

            <table class="table table-bordered table-hover">
                <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Date & Time</th>
                    <th>Location</th>
                    <th>Status</th>
                    <th>Customer</th>
                    <th>Action</th>
                </tr>
                </thead>

                <tbody id="appointmentsTable">
                </tbody>
            </table>

        </div>
    </div>

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Common JS -->
<script src="api.js"></script>

<script>
// Load navbar
fetch("/navbar.html")
    .then(res => res.text())
    .then(data => document.getElementById("navbar").innerHTML = data);

function loadAppointments() {
    fetch("/api/professional/appointments", {
        headers: authHeaders()
    })
    .then(res => res.json())
    .then(data => {
        const table = document.getElementById("appointmentsTable");
        table.innerHTML = "";

        data.forEach(a => {
            let badge = "secondary";
            if (a.status === "CREATED") badge = "warning";
            if (a.status === "ACCEPTED") badge = "info";
            if (a.status === "IN_PROGRESS") badge = "primary";
            if (a.status === "COMPLETED") badge = "success";
            if (a.status === "CANCELLED") badge = "danger";

            let actionBtn = "";
            if (a.status === "CREATED") {
                actionBtn = `<button class="btn btn-sm btn-success"
                                  onclick="accept(${a.appointmentId})">
                                  Accept
                             </button>`;
            }

            table.innerHTML += `
                <tr>
                    <td>${a.appointmentId}</td>
                    <td>${a.dateTime}</td>
                    <td>${a.location}</td>
                    <td><span class="badge bg-${badge}">${a.status}</span></td>
                    <td>${a.customer?.fullName || ""}</td>
                    <td>${actionBtn}</td>
                </tr>
            `;
        });
    });
}

function accept(id) {
    fetch(`/api/professional/appointment/${id}/accept`, {
        method: "PUT",
        headers: authHeaders()
    })
    .then(() => {
        alert("Appointment accepted");
        loadAppointments();
    });
}
</script>

</body>
</html>
