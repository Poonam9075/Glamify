<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	
    <title>Customer Dashboard</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          rel="stylesheet">
</head>

<body onload="requireAuth(); initPage();">

<!-- NAVBAR -->
<div id="navbar"></div>

<div class="container mt-4">

    <h3 class="mb-4">My Appointments</h3>

    <!-- APPOINTMENT TABLE -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <table class="table table-bordered table-hover align-middle">
                <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Date & Time</th>
                    <th>Location</th>
                    <th>Status</th>
                    <th>Service</th>
                    <th>Professional</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody id="appointmentsTable"></tbody>
            </table>
        </div>
    </div>

    <!-- BOOK APPOINTMENT -->
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            Book New Appointment
        </div>
        <div class="card-body">

            <!-- LOCATION -->
            <div class="mb-3">
                <label class="form-label">Location</label>
                <input type="text" id="location"
                       class="form-control"
                       placeholder="City / Address">
            </div>

            <!-- TIME SLOT -->
            <div class="mb-3">
                <label class="form-label">Time Slot</label>
                <select id="timeSlot" class="form-select">
				    <option value="2025-02-01T10:00:00">10:00 AM – 12:00 PM</option>
				    <option value="2025-02-01T12:00:00">12:00 PM – 2:00 PM</option>
				    <option value="2025-02-01T14:00:00">2:00 PM – 4:00 PM</option>
				    <option value="2025-02-01T16:00:00">4:00 PM – 6:00 PM</option>
				</select>
            </div>

            <!-- SERVICE DROPDOWN (DB DATA) -->
            <div class="mb-3">
                <label class="form-label">Required Service</label>
                <select id="serviceSelect" class="form-select" multiple size="5"></select>
            </div>

            <button class="btn btn-success" onclick="bookAppointment()">
                Book Appointment
            </button>

        </div>
    </div>

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Common JS -->
<script src="api.js"></script>

<script>
/* ===========================
   INIT
   =========================== */

fetch("/navbar.html")
    .then(res => res.text())
    .then(html => document.getElementById("navbar").innerHTML = html);

function initPage() {
    loadServices();
    loadAppointments();
}

/* ===========================
   LOAD SERVICES FROM DB
   =========================== */

function loadServices() {
    fetch("/api/customer/services", {
        headers: authHeaders()
    })
    .then(res => {
        console.log("SERVICE API STATUS:", res.status);
        return res.json();
    })
    .then(services => {
        console.log("SERVICES FROM DB:", services);

        const select = document.getElementById("serviceSelect");
        select.innerHTML = "";

        if (services.length === 0) {
            const opt = document.createElement("option");
            opt.text = "No services available";
            opt.disabled = true;
            select.appendChild(opt);
            return;
        }

        services.forEach(s => {
            const opt = document.createElement("option");
            opt.value = s.id;
            opt.text = s.name + " (₹" + s.price + ")";
            select.appendChild(opt);
        });
    })
    .catch(err => console.error("SERVICE LOAD ERROR", err));
}

/* ===========================
   LOAD APPOINTMENTS
   =========================== */

function loadAppointments() {
    fetch("/api/customer/appointments", {
        headers: authHeaders()
    })
    .then(res => res.json())
    .then(data => {
        const t = document.getElementById("appointmentsTable");
        t.innerHTML = "";

        data.forEach(a => {
            let badge = "secondary";
            if (a.status === "CREATED") badge = "warning";
            if (a.status === "ACCEPTED") badge = "info";
            if (a.status === "IN_PROGRESS") badge = "primary";
            if (a.status === "COMPLETED") badge = "success";
            if (a.status === "CANCELLED") badge = "danger";

            let action = "";
            if (a.status === "CREATED" || a.status === "ACCEPTED") {
                action = `
                    <button class="btn btn-sm btn-danger"
                            onclick="cancelAppointment(${a.appointmentId})">
                        Cancel
                    </button>`;
            }

            t.innerHTML += `
                <tr>
                    <td>${a.appointmentId}</td>
                    <td>${a.dateTime}</td>
                    <td>${a.location}</td>
                    <td><span class="badge bg-${badge}">${a.status}</span></td>
                    <td>
                      ${
                         a.bookedServices
                           ? a.bookedServices.map(bs => bs.beautyService.name).join(", ")
                           : ""
                       }
                    </td>
                    <td>${a.professional?.fullName || "Auto Assigned"}</td>
                    <td>${action}</td>
                </tr>
            `;
        });
    });
}

/* ===========================
   BOOK APPOINTMENT
   =========================== */

   function bookAppointment() {
	    const serviceSelect = document.getElementById("serviceSelect");

	    const serviceIds = Array.from(serviceSelect.selectedOptions)
	                            .map(opt => Number(opt.value));

	    const body = {
	        location: document.getElementById("location").value,
	        dateTime: document.getElementById("timeSlot").value,
	        serviceIds: serviceIds
	    };

	    console.log("BOOK PAYLOAD:", body);

	    fetch("/api/customer/appointment", {
	        method: "POST",
	        headers: authHeaders(),
	        body: JSON.stringify(body)
	    })
	    .then(res => res.json())
	    .then(() => {
	        alert("Appointment booked successfully");
	        loadAppointments();
	    });
	}


/* ===========================
   CANCEL
   =========================== */

function cancelAppointment(id) {
    if (!confirm("Cancel this appointment?")) return;

    fetch(`/api/customer/appointment/${id}/cancel`, {
        method: "PUT",
        headers: authHeaders()
    }).then(loadAppointments);
}
</script>

</body>
</html>
